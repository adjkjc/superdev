#!/bin/sh

BOLD=$(tput bold)
NORMAL="\033[0m"

RED='01;31'
GREEN='01;32'
ORANGE='01;33'

SUPERVISORCTL=.tox/dev/bin/supervisorctl
DOCKER_FORMAT="table {{.Names}}\\t{{.Image}}\\t{{.Status}}"
DOCKER_CONTAINERS="h_elasticsearch|h_postgres|h_rabbit|lms_postgres"

highlight() {
  GREP_COLOR=$1 grep --color=always -E "$2|$"
}

#-------------------------------------------

echo "${BOLD}Services${NORMAL}\n"

nmap --datadir conf/ localhost | \
    grep -E "PORT|tcp" | highlight $RED closed | highlight $GREEN open

#-------------------------------------------

echo "\n${BOLD}Docker containers${NORMAL}\n"

docker ps -a --format "$DOCKER_FORMAT" --filter name="$DOCKER_CONTAINERS" | \
  highlight $RED Exited | \
  highlight $GREEN Up

#-------------------------------------------

echo "\n${BOLD}Supervisor processes${NORMAL}\n"

if [ -e $SUPERVISORCTL ]
then
  $SUPERVISORCTL status | \
    highlight $RED "FATAL|refused connection" | \
    highlight $ORANGE EXITED | highlight $GREEN RUNNING

else
    echo "No tox environment. Run make dev"
fi
